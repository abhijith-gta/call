<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>SwapLoop - Chat</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            /* DARK MODE (Default) */
            --bg: #000000;
            --surface: #1c1c1e;
            --text-primary: #ffffff;
            --text-secondary: #8e8e93;
            --accent: #0a84ff;
            --accent-gradient: linear-gradient(135deg, #0a84ff 0%, #5e5ce6 100%);
            --border: rgba(255, 255, 255, 0.1);
            --msg-sent: linear-gradient(135deg, #0a84ff 0%, #007aff 100%);
            --msg-received: #2c2c2e;
            --input-bg: rgba(255, 255, 255, 0.1);
            --btn-hover: rgba(255, 255, 255, 0.1);
        }

        [data-theme="light"] {
            --bg: #f2f2f7;
            --surface: #ffffff;
            --text-primary: #000000;
            --text-secondary: #8e8e93;
            --accent: #007aff;
            --accent-gradient: linear-gradient(135deg, #007aff 0%, #5856d6 100%);
            --border: rgba(0, 0, 0, 0.1);
            --msg-sent: linear-gradient(135deg, #007aff 0%, #0062cc 100%);
            --msg-received: #e5e5ea;
            --input-bg: rgba(0, 0, 0, 0.05);
            --btn-hover: rgba(0, 0, 0, 0.05);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text-primary);
            height: 100dvh; /* Dynamic Height for Mobile Keyboards */
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Theme Toggle */
        .theme-toggle {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--input-bg);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            z-index: 50;
            transition: transform 0.2s;
        }
        .theme-toggle:active { transform: scale(0.9); }

        /* Setup Card */
        .satin-card {
            background-color: var(--surface);
            border: 1px solid var(--border);
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            transition: background 0.3s;
        }

        /* Message Bubbles */
        .chat-bubble {
            max-width: 80%;
            padding: 10px 16px;
            border-radius: 20px;
            font-size: 0.95rem;
            line-height: 1.4;
            position: relative;
            animation: slideIn 0.2s cubic-bezier(0.25, 1, 0.5, 1) forwards;
            opacity: 0;
            transform: translateY(10px);
            word-wrap: break-word;
        }

        .sent {
            background: var(--msg-sent);
            align-self: flex-end;
            border-bottom-right-radius: 4px;
            color: white;
            box-shadow: 0 2px 10px rgba(10, 132, 255, 0.3);
        }

        .received {
            background: var(--msg-received);
            align-self: flex-start;
            border-bottom-left-radius: 4px;
            color: var(--text-primary);
        }

        @keyframes slideIn { to { opacity: 1; transform: translateY(0); } }

        /* Bottom Input Bar */
        .input-area {
            background: var(--surface);
            border-top: 1px solid var(--border);
            padding: 10px 16px;
            /* Ensure padding accounts for mobile safe areas */
            padding-bottom: max(10px, env(safe-area-inset-bottom));
        }

        .glass-input {
            background: var(--input-bg);
            border: 1px solid transparent;
            color: var(--text-primary);
            transition: all 0.2s;
        }
        .glass-input:focus { outline: none; border-color: var(--accent); background: var(--bg); }

        /* Action Buttons */
        .btn-skip {
            background: var(--input-bg);
            color: var(--text-secondary);
            border-radius: 50%;
            width: 42px; height: 42px;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
            border: 1px solid var(--border);
        }
        .btn-skip:active { transform: scale(0.9); background: var(--border); }

        .btn-send {
            background: var(--accent);
            color: white;
            border-radius: 50%;
            width: 42px; height: 42px;
            display: flex; align-items: center; justify-content: center;
            transition: transform 0.2s;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .btn-send:active { transform: scale(0.9); }

        /* Toggles */
        .toggle-btn {
            background: var(--input-bg);
            color: var(--text-secondary);
            border: 1px solid transparent;
        }
        .toggle-btn.active {
            background: var(--accent);
            color: white;
        }

        /* Scrollbar */
        #messages-area::-webkit-scrollbar { width: 4px; }
        #messages-area::-webkit-scrollbar-thumb { background: rgba(128,128,128,0.3); border-radius: 4px; }
    </style>
</head>
<body>

    <button id="theme-btn" class="theme-toggle" aria-label="Toggle Dark Mode">
        <svg id="moon-icon" class="w-5 h-5 text-[var(--text-primary)]" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
        <svg id="sun-icon" class="hidden w-5 h-5 text-[var(--text-primary)]" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
    </button>

    <div id="setup-screen" class="fixed inset-0 z-40 flex items-center justify-center p-4 bg-black/50 backdrop-blur-md">
        <div class="satin-card w-full max-w-sm p-8 rounded-2xl text-center shadow-2xl">
            <div class="w-16 h-16 bg-[var(--input-bg)] rounded-2xl mx-auto flex items-center justify-center mb-6">
                <span class="text-3xl">ðŸ’¬</span>
            </div>
            <h1 class="text-3xl font-bold mb-8">Text Chat</h1>
            
            <div class="space-y-6">
                <input id="nickname-input" type="text" placeholder="Enter Nickname" class="glass-input w-full p-4 rounded-xl text-center font-medium">
                
                <div class="text-left">
                    <label class="text-xs uppercase tracking-wider text-[var(--text-secondary)] font-bold ml-1 mb-2 block">I am</label>
                    <div id="my-gender-selector" class="grid grid-cols-2 gap-3">
                        <button class="toggle-btn p-3 rounded-xl font-medium" data-gender="male">Male</button>
                        <button class="toggle-btn p-3 rounded-xl font-medium" data-gender="female">Female</button>
                    </div>
                </div>

                <div class="text-left">
                    <label class="text-xs uppercase tracking-wider text-[var(--text-secondary)] font-bold ml-1 mb-2 block">Looking for</label>
                    <div id="looking-for-selector" class="grid grid-cols-3 gap-3">
                        <button class="toggle-btn p-3 rounded-xl font-medium" data-gender="male">Male</button>
                        <button class="toggle-btn p-3 rounded-xl font-medium" data-gender="female">Female</button>
                        <button class="toggle-btn active p-3 rounded-xl font-medium" data-gender="anyone">Anyone</button>
                    </div>
                </div>

                <button id="start-button" class="w-full bg-[var(--accent)] text-white font-bold p-4 rounded-xl mt-4 shadow-lg active:scale-95 transition-transform">
                    Start Chatting
                </button>
            </div>
        </div>
    </div>

    <div id="chat-ui" class="flex flex-col h-full hidden">
        
        <div class="h-14 flex items-center justify-between px-4 border-b border-[var(--border)] bg-[var(--surface)] shrink-0 z-10">
            <div>
                <h2 id="partner-nickname" class="text-base font-bold leading-tight">Stranger</h2>
                <div class="flex items-center gap-1.5">
                    <span id="status-dot" class="w-1.5 h-1.5 rounded-full bg-yellow-500 animate-pulse"></span>
                    <p id="status-text" class="text-xs font-medium text-yellow-500">Searching...</p>
                </div>
            </div>
            
            <div id="typing-indicator" class="hidden text-xs text-[var(--accent)] font-medium animate-pulse px-3 py-1 bg-[var(--input-bg)] rounded-full">
                typing...
            </div>
        </div>

        <div id="messages-area" class="flex-grow flex flex-col gap-2 p-4 overflow-y-auto scroll-smooth">
            <div class="text-center text-xs text-[var(--text-secondary)] mt-4 mb-8 uppercase tracking-widest opacity-60">Start of conversation</div>
        </div>

        <form id="chat-form" class="input-area flex gap-3 items-center shrink-0">
            <button type="button" id="next-button" class="btn-skip" title="Next Stranger">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path d="M13 5l7 7-7 7M5 5l7 7-7 7"/></svg>
            </button>

            <input id="chat-input" type="text" placeholder="Type a message..." autocomplete="off" class="glass-input flex-grow py-2.5 px-4 rounded-full text-base">

            <button type="submit" class="btn-send">
                <svg class="w-5 h-5 translate-x-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg>
            </button>
        </form>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // --- Theme Logic ---
        const themeBtn = document.getElementById('theme-btn');
        const moonIcon = document.getElementById('moon-icon');
        const sunIcon = document.getElementById('sun-icon');
        
        const savedTheme = localStorage.getItem('theme') || 'dark';
        document.documentElement.setAttribute('data-theme', savedTheme);
        updateIcons(savedTheme);

        themeBtn.addEventListener('click', () => {
            const current = document.documentElement.getAttribute('data-theme');
            const newTheme = current === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateIcons(newTheme);
        });

        function updateIcons(theme) {
            if (theme === 'dark') {
                moonIcon.classList.remove('hidden');
                sunIcon.classList.add('hidden');
            } else {
                moonIcon.classList.add('hidden');
                sunIcon.classList.remove('hidden');
            }
        }

        // --- Chat Logic ---
        const socket = io();
        let myGender, lookingFor = 'anyone';

        const ui = {
            setupScreen: document.getElementById('setup-screen'),
            chatUI: document.getElementById('chat-ui'),
            startBtn: document.getElementById('start-button'),
            nickInput: document.getElementById('nickname-input'),
            partnerName: document.getElementById('partner-nickname'),
            statusText: document.getElementById('status-text'),
            statusDot: document.getElementById('status-dot'),
            typingInd: document.getElementById('typing-indicator'),
            msgsArea: document.getElementById('messages-area'),
            form: document.getElementById('chat-form'),
            input: document.getElementById('chat-input'),
            nextBtn: document.getElementById('next-button')
        };

        function setupSelectors(id, callback) {
            const container = document.getElementById(id);
            const btns = container.querySelectorAll('.toggle-btn');
            btns.forEach(btn => {
                btn.addEventListener('click', () => {
                    btns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    callback(btn.dataset.gender);
                });
            });
        }
        setupSelectors('my-gender-selector', val => myGender = val);
        setupSelectors('looking-for-selector', val => lookingFor = val);

        ui.startBtn.addEventListener('click', () => {
            if (!myGender) return alert("Please select your gender.");
            const nick = ui.nickInput.value.trim() || "Anonymous";
            socket.emit("set-nickname", nick);
            
            ui.setupScreen.classList.add('hidden');
            ui.chatUI.classList.remove('hidden');
            
            findPartner();
        });

        function findPartner() {
            updateStatus('searching');
            ui.msgsArea.innerHTML = '<div class="text-center text-xs text-[var(--text-secondary)] mt-4 mb-8 uppercase tracking-widest opacity-60">Start of conversation</div>';
            socket.emit("find-partner", { gender: myGender, lookingFor, type: 'text' });
        }

        ui.nextBtn.addEventListener('click', () => {
            socket.emit("next");
            findPartner();
        });

        ui.form.addEventListener('submit', (e) => {
            e.preventDefault();
            const msg = ui.input.value.trim();
            if (msg) {
                socket.emit('send-message', { message: msg });
                appendMsg(msg, 'sent');
                ui.input.value = '';
                socket.emit('typing', false); 
            }
        });

        function appendMsg(text, type) {
            const div = document.createElement('div');
            div.textContent = text;
            div.className = `chat-bubble ${type}`;
            ui.msgsArea.appendChild(div);
            ui.msgsArea.scrollTop = ui.msgsArea.scrollHeight;
        }

        ui.input.addEventListener('input', () => {
            socket.emit('typing', true);
            clearTimeout(window.typingTimeout);
            window.typingTimeout = setTimeout(() => socket.emit('typing', false), 2000);
        });

        socket.on('partner-typing', (isTyping) => {
            ui.typingInd.style.display = isTyping ? 'block' : 'none';
        });

        socket.on('partner-found', ({ partnerNickname }) => {
            updateStatus('connected', partnerNickname);
        });

        socket.on('receive-message', ({ message }) => {
            appendMsg(message, 'received');
        });

        socket.on('partner-disconnected', () => {
            updateStatus('disconnected');
            setTimeout(() => {
                socket.emit('next');
                findPartner();
            }, 1500); 
        });

        function updateStatus(state, name="Stranger") {
            ui.partnerName.textContent = name;
            ui.statusDot.className = "w-1.5 h-1.5 rounded-full";
            ui.input.disabled = (state !== 'connected');
            ui.typingInd.style.display = 'none';

            if (state === 'searching') {
                ui.statusText.textContent = "Searching...";
                ui.statusText.style.color = "#eab308"; // yellow
                ui.statusDot.className = "w-1.5 h-1.5 rounded-full bg-yellow-500 animate-pulse";
            } else if (state === 'connected') {
                ui.statusText.textContent = "Online";
                ui.statusText.style.color = "#22c55e"; // green
                ui.statusDot.className = "w-1.5 h-1.5 rounded-full bg-green-500";
                ui.input.focus();
            } else if (state === 'disconnected') {
                ui.statusText.textContent = "Disconnected";
                ui.statusText.style.color = "#ef4444"; // red
                ui.statusDot.className = "w-1.5 h-1.5 rounded-full bg-red-500";
            }
        }
    </script>
</body>
</html>